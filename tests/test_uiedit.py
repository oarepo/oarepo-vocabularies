from pathlib import Path

from invenio_access.permissions import system_identity
from invenio_vocabularies.proxies import current_service as vocab_service
from oarepo_runtime.datastreams.fixtures import FixturesCallback, load_fixtures

from oarepo_vocabularies.records.api import Vocabulary
from tests.test_uidetail import remove_ws


def test_uiedit(
    client_with_credentials,
    app,
    db,
    cache,
    lang_type,
    lang_data,
    vocab_cf,
    fake_manifest,
    search_clear,
):
    for _id in range(100):
        vocab_service.create(
            system_identity,
            {
                **lang_data,
                "id": str(_id),
            },
        )
    Vocabulary.index.refresh()
    edit_page = client_with_credentials.get("/vocabularies/languages/1/edit")
    assert edit_page.status_code == 200
    print(edit_page.text)
    assert (
        remove_ws(
            """  
        {"all": [{"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "0"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "1"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "2"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "3"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "4"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "5"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "6"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "7"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "8"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "9"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "10"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "11"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "12"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "13"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "14"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "15"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "16"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "17"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "18"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "19"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "20"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "21"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "22"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "23"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "24"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "25"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "26"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "27"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "28"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "29"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "30"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "31"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "32"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "33"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "34"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "35"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "36"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "37"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "38"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "39"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "40"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "41"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "42"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "43"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "44"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "45"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "46"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "47"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "48"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "49"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "50"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "51"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "52"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "53"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "54"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "55"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "56"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "57"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "58"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "59"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "60"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "61"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "62"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "63"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "64"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "65"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "66"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "67"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "68"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "69"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "70"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "71"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "72"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "73"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "74"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "75"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "76"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "77"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "78"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "79"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "80"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "81"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "82"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "83"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "84"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "85"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "86"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "87"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "88"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "89"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "90"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "91"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "92"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "93"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "94"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "95"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "96"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "97"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "98"}, {"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "props": {"akey": "avalue"}, "tags": ["recommended"], "text": "English", "value": "99"}], "definition": {"description": {"cs": "slovnikovy typ ceskeho jazyka.", "en": "czech language vocabulary type."}
            """
        )
        in remove_ws(edit_page.text)
    )


def test_uiedit_locale(
    client_with_credentials,
    app,
    db,
    cache,
    vocab_cf,
    fake_manifest,
    reset_babel,
    search_clear,
):
    load_fixtures(Path(__file__).parent / "icudata", callback=FixturesCallback())
    Vocabulary.index.refresh()

    reset_babel()
    edit_page = client_with_credentials.get(
        "/vocabularies/languages/en/edit", headers=[("Accept-Language", "cs")]
    )
    print(edit_page.text)
    assert (
        remove_ws(
            """  
"languages": {"all": [
{"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["Angli\\u010dtina"]}, "text": "Angli\\u010dtina", "value": "en"}, 
{"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["\\u010ce\\u0161tina"]}, "text": "\\u010ce\\u0161tina", "value": "cs"}
        """
        )
        in remove_ws(edit_page.text)
    )

    reset_babel()
    edit_page = client_with_credentials.get(
        "/vocabularies/languages/en/edit", headers=[("Accept-Language", "en")]
    )
    assert (
        remove_ws(
            """  
"languages": {"all": [
{"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["Czech"]}, "text": "Czech", "value": "cs"}, 
{"element_type": "leaf", "hierarchy": {"ancestors": [], "title": ["English"]}, "text": "English", "value": "en"}            
"""
        )
        in remove_ws(edit_page.text)
    )
